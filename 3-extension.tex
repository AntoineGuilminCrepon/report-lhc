%TEX root = main.tex
\section{Description of the extension}

The main point of the extension is to add an object to the language complementary to the $\mathbf{wp}_{\forall}$ from the original model.

This object is defined as such :

\begin{definition}[Weakest existential precondition]
$\WPE{\m{t}}{Q} := \lambda s. \E s' v. \bigstep t s v {s'} \land Q(v)$
\end{definition}

This object behaves in the same way as $\mathbf{wp}_{\forall}$ for most of the rules previously described. Those rules are written down for completeness. Most of the rules can be mirrored as is (just switching a $\mathbf{wp}_{\forall}$ for a $\mathbf{wp}_{\exists}$), but some needs more changes.

\textsc{wp$_{exists}$-exists} mirrors \textsc{wp$_{\forall}$-all}, but uses existential quantifiers instead of universal ones. Without much surprise, $\mathbf{wp}_{\exists}$ works better with existentials. \textsc{wp$_{\exists}$-while$_I$} was modified to take into account the necessity of projectability for $\mathbf{wp}_{\exists}$ statements.

\begin{mathfig}{\small}
    \begin{proofrules}
        \input{rules/wpE-cons.tex}

        \input{rules/wpE-exists.tex}

        \input{rules/wpE-frame.tex}

        \input{rules/wpE-impl-r.tex}

        \input{rules/wpE-subst.tex}

        \input{rules/wpE-idx.tex}

        \input{rules/wpE-seq.tex}

        \input{rules/wpE-assign.tex}

        \input{rules/wpE-if.tex}

        \input{rules/wpE-while.tex}

        \input{rules/wpE-nest.tex}

        \input{rules/wpE-conj.tex}

        \input{rules/wpE-idx-pass.tex}

        \input{rules/wpE-idx-swap.tex}

        \input{rules/wpE-idx-merge.tex}

        \input{rules/wpE-idx-post.tex}
    \end{proofrules}
    \caption{Rules for $\mathbf{wp}_{\exists}$ mirrored on $\mathbf{wp}_{\forall}$}
\end{mathfig}

An interesting point is that predicates that couldn't be defined in the original theory using the base langugage, and thus needed to be explicitly defined to be used, can now be defined using this new $\mathbf{wp}_{\exists}$ object.

\begin{eqnarray*}
    \proj(t) &:=& \WPE{\m{t}}{\True} \\
    t_1 \semleq t_2 &:=& \V s(1)=s(2) |- \WPU{[1: t_1]}{\WPE{[2: t_2]}{v(1) = v(2) \land s(1) = s(2)}}
\end{eqnarray*}

Thus certain rules from LHC can now be rewritten by combining $\mathbf{wp}_{\forall}$ and $\mathbf{wp}_{\exists}$

\begin{mathfig}{\small}
    \begin{proofrules}
        \input{rules/wp-refine.tex}

        \input{rules/wp-proj.tex}
    \end{proofrules}
    \caption{Rules rewritten using $\mathbf{wp}_{\exists}$}
\end{mathfig}

\begin{mathfig}{\small}
    \begin{proofrules}
        \input{rules/wp-triv.tex}

        \input{rules/proj-elim}

        \input{rules/wp-while.tex}
    \end{proofrules}
    \caption{Rules combining $\mathbf{wp}_{\forall}$ and $\mathbf{wp}_{\exists}$}
\end{mathfig}

With the use of $\mathbf{wp}_{\exists}$, one can write an interesting property:
\begin{eqnarray*}
    PDet(t) &:=& \WPE {\m{t}} Q \lequiv \WPU {\m{t}} Q
\end{eqnarray*}

This property is in fact equivalent to $Det(t) \land \proj(t)$, as is shown below.

\begin{lemma}[$Det(t)\land\proj(t) \iff PDet(t)$]
\end{lemma} 
\begin{proof}
    If $\m{t}$ is deterministic and has a terminating trace, then any terminating trace gives the same output, given the same input. Thus, if there exists a trace that satisfies some property $Q$, then any trace will satisfy the same property. Therefore, we have the direct statement.

    For the reciprocal, we will separate the proof of $PDet(t) \implies Det(t)\land\proj(t)$ in two separate derivations. First off, $PDet(t) \implies \proj(t)$.

    \begin{prooftree}
        \AxiomC{}
        \LeftLabel{\scriptsize\textsf{wp$_{\forall}$-triv}}
        \UnaryInfC{$\V |- \WPU {\m{t}}{\True}$}
        \AxiomC{}
        \RightLabel{\scriptsize{$PDet(t)$}}
        \UnaryInfC{$\V \WPU {\m{t}}{\True} |- \WPE {\m{t}}{\True}$}
        \BinaryInfC{$\V |- \WPE {\m{t}}{\True}$}
    \end{prooftree}

    Next, $PDet(t) \implies Det(t)$.
    \begin{scprooftree}{0.9}
        \AxiomC{$\V \pv{x}(\I1)=\pv{x}(\I2) |- \WPE {\m<\I1: t, \I2: t>}{\pv{x}(\I1)=\pv{x}(\I2)}$}
        \AxiomC{}
        \RightLabel{\scriptsize{$PDet(t)$}}
        \UnaryInfC{$\V \WPE {\m<\I1: t, \I2: t>}{\pv{x}(\I1)=\pv{x}(\I2)} |- \WPU {\m<\I1: t, \I2: t>}{\pv{x}(\I1)=\pv{x}(\I2)}$}
        \BinaryInfC{$\V \pv{x}(\I1)=\pv{x}(\I2) |- \WPU {\m<\I1: t,\I2: t>}{\pv{x}(\I1)=\pv{x}(\I2)}$}
    \end{scprooftree}

    The left-side assumption is proved the following way: given that both terms receive the same input, if we chose the same trace to execute in both terms, we then get the same output (i.e every term is "deterministic" in the context of $\mathbf{wp}_{\exists}$).

    Thus we get an equivalence between $PDet(t)$ and $Det(t)\land\proj(t)$
\end{proof}

As stated before, $\mathbf{wp}_{\exists}$ behaves more or less the same way as $\mathbf{wp}_{\forall}$, and thus, proofs using it exclusively are very similar in form. Most of the capabilities of this model appears when combining both operators. However, one would need rules to deal with hyperproperties combining the two $\mathbf{wp}$.

A pair of such rules are \textsc{wp-swap} and \textsc{wp-swap-local}.

\begin{mathfig}{\small}
    \begin{proofrules}        
        \input{rules/wp-swap.tex}

        \input{rules/wp-swap-local.tex}
    \end{proofrules}
\end{mathfig}